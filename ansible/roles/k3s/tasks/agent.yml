---
# Install k3s agent (worker nodes)

- name: Check if k3s is already installed
  ansible.builtin.stat:
    path: /usr/local/bin/k3s
  register: k3s_binary

- name: Debug - show master info
  ansible.builtin.debug:
    msg: "Joining master at {{ k3s_master_ip }} with token {{ k3s_token[:20] }}..."

- name: Install k3s agent
  ansible.builtin.shell: |
    curl -sfL https://get.k3s.io | sh -s - agent \
      --server https://{{ k3s_master_ip }}:6443 \
      --token {{ k3s_token }} \
      --node-name {{ inventory_hostname }}
  args:
    creates: /usr/local/bin/k3s
  when: not k3s_binary.stat.exists

- name: Wait for k3s-agent service to be running
  ansible.builtin.systemd:
    name: k3s-agent
    state: started
    enabled: yes

- name: Verify agent joined cluster
  ansible.builtin.shell: |
    k3s kubectl get node {{ inventory_hostname }}
  delegate_to: "{{ groups['master'][0] }}"
  register: node_joined
  until: node_joined.rc == 0
  retries: 30
  delay: 10
  changed_when: false
