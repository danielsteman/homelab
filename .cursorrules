# Homelab Project Rules

## GitOps Philosophy

**Git is the single source of truth.** Every decision should prioritize:

### Core Principles

1. **Declarative over Imperative**: Define _what_ you want, not _how_ to get there

   - Prefer Kubernetes manifests, Terraform, Ansible over manual commands
   - No `kubectl apply` or `docker run` without corresponding committed config

2. **Version Controlled**: All configuration lives in Git

   - Infrastructure changes = Pull Requests
   - History provides audit trail and rollback capability

3. **Automated Reconciliation**: The system converges to the desired state

   - Use ArgoCD/Flux for Kubernetes workloads
   - Changes in Git trigger automatic deployment
   - Drift detection and self-healing

4. **Pull-based Deployments**: Cluster pulls desired state from Git

   - No CI/CD pushing directly to cluster
   - Cluster agents watch Git repos for changes

5. **Immutable Infrastructure**: Replace, don't mutate
   - New container image = new deployment
   - VM changes via Terraform destroy/recreate when practical

### Decision Framework

When adding something new, ask:

- [ ] Is it defined declaratively in a file I can commit?
- [ ] Can it be recreated from scratch using only this repo?
- [ ] Will changes be applied automatically when I push to Git?
- [ ] Are secrets encrypted with SOPS (_.enc.yaml, _.enc.env)?

### Tool Preferences

| Layer          | GitOps Tool                     | Purpose                        |
| -------------- | ------------------------------- | ------------------------------ |
| Kubernetes     | ArgoCD or Flux                  | Continuous deployment from Git |
| Secrets        | **SOPS + age**                  | Git-safe secret encryption     |
| Infrastructure | Terraform + Atlantis (optional) | IaC with PR-based workflows    |
| Configuration  | Ansible                         | Idempotent node configuration  |

### Secret Management (SOPS + age)

- Encrypt secrets before committing: `sops --encrypt file.yaml > file.enc.yaml`
- Use naming convention: `*.enc.yaml`, `*.enc.env`, `*.enc.json`
- Never commit: `age-key.txt`, `*.dec.*`, plain `.env` files
- Edit encrypted files in-place: `sops file.enc.yaml`

### Anti-patterns to Avoid

- Manual `kubectl` changes without updating manifests
- Secrets stored as plain text or only in `.env` files
- Configuration that exists only in a running container
- "Just SSH in and fix it" mentality

## Documentation

- When adding a new service (docker-compose, k8s manifest, etc.), always update the README.md:
  - Add to the "Services" table
  - Add to the "Directory Structure" section if creating a new folder
  - Update architecture diagram if relevant

## Services Table Format

When adding a service to README.md, use this format:

```markdown
| Service Name | Brief description |
```

## Directory Structure

Each service should have:

- `compose.yml` or deployment manifest
- `README.md` with setup instructions
- `.gitignore` for secrets/generated files
- `env.example` for environment variables (never commit actual `.env`)

## Security

- Never commit unencrypted secrets, passwords, or API tokens
- Use SOPS + age to encrypt secrets before committing (`*.enc.yaml`, `*.enc.env`)
- Always add `.env` and `age-key.txt` files to `.gitignore`
- Create `*.example.env` templates showing required variables (without real values)

## Infrastructure as Code

- Ansible: Configuration management and template creation
- Terraform: VM provisioning on Proxmox
- Docker Compose: Services running on Proxmox host

## Naming Conventions

- Folders: lowercase, hyphenated (e.g., `home-assistant`)
- Docker containers: lowercase, hyphenated
- Terraform resources: snake_case
- Ansible roles: lowercase, hyphenated
